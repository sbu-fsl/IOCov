# IOCov scripts: parser and plotter

## Workflow

Basically, the workflow of IOCov includes tracing, parsing, and plotting.

- Tracing: tracing methods depend on the file system testers.  We use 
    - `xfstests` and `CrashMonkey`: LTTng
    - `MCFS`: own MCFS logs 
    - `Syzkaller`: Syzkaller's [Syscall descriptions](https://github.com/google/syzkaller/blob/master/docs/syscall_descriptions.md). Download webpages of Syzkaller.
- Parsing: transforming raw syscall logs to pickle files with dictionaries that contain input/output partitions.
- Plotting: visualization of input and output coverage. 

## Prerequisites

### Python packages

pandas, matplotlib

## Usage

The main entry of the parser and plotter is `iocov-main.py`.  The 
first step is parsing the logs from LTTng, while parsing Syzkaller
webpages need the scripts in the `../Syzkaller`.  To parse LTTng logs,
we should edit three fields in the `iocov-main.py`: `default_plot_name`,
`default_is_mcfs`, and `default_lttng_log`.

- `default_plot_name`: prefix/suffix for the plot names pkl/json filenames.  
    - For example, `default_plot_name = 'xfstests_xattr_open_dump'` indicates that 
      IOCov will write the parsed input and output coverage to `input_cov_xfstests_xattr_open_dump.pkl`,
      `output_cov_xfstests_xattr_open_dump.pkl` and `unfilter_input_cov_xfstests_xattr_open_dump.pkl`.
    - Meanwhile, IOCov looks for these pickle files (i.e., `input_cov_xfstests_xattr_open_dump.pkl`)
      and load them to plot corresponding figures for input and output coverage.
      `default_plot_name` is also the suffix of plot titles by replacing `_`
      with space ` ` (i.e., `replace('_', ' ')`) and the prefix of intermediate 
      pkl files generated by IOCov plotter --- we can expect the  `xfstests_xattr_open_dump_input_coords.pkl`
      and `xfstests_xattr_open_dump_output_coords.pkl` as the X/Y-axis data pickled 
      by the plotter.  
    - Finally, `default_plot_name` serves as the prefix of 
      the file name of PDF plots where file names format as `prefix-input-syscall-param.pdf`. 
      Python code for plot file name:`'{}-input-{}-{}.{}'.format(self.plot_prefix, sc, param, self.plot_format)`
- `default_is_mcfs`: boolean variable to specify if we are processing 
  input and output coverage for MCFS.  `True` means MCFS.  `is_mcfs` 
  is required by IOCov parser because MCFS needs to be handled specially.
- `default_lttng_log`: pathname to the LTTng log file.  For example,
  `default_lttng_log = xfstests-lttng-all-related-ext4-all-xattrs-4633.log`
  is passed to IOCov parser so IOCov reads this log line by line and 
  parse the information to obtain the dictionary (pkl/json files) for 
  further analysis and plotting. 

After editting these global variables, we run the following command to execute 
IOCov parser if parsing is required:

```bash
python3 iocov-main.py default_plot_name --parse
```

When we only have the pickle files for the parsed input/output coverage
but no json file exists, 
we run the following command to produce corresponding json files:

```bash
python3 iocov-main.py default_plot_name --no-parse --json
```

If the input/output coverage is already parsed (pkl files are available),
we run IOCov plotter to get the plots to visualize input and output coverage 
for various syscalls and arguments/returns:

```bash
python3 iocov-main.py default_plot_name --no-parse --plot
```

Run the following command to also plot unfiltered input coverage with a 
stacked bar plot format:

```bash
python3 iocov-main.py default_plot_name --no-parse --plot --plotunfilter
```

Run the following command to plot input coverage only:

```bash
python3 iocov-main.py default_plot_name --no-parse --plot -i
```

Run the following command to plot output coverage only:

```bash
python3 iocov-main.py default_plot_name --no-parse --plot -o
```

The generated plots (PDF files) are stored to the `./Assets/Input-Figures`
and `./Assets/Output-Figures` directories.

## Syzkaller

Parsing Syzkaller syscalls is documented at [README](../Syzkaller/README.md).

To plot Syzkaller input coverage, change `default_plot_name` in `iocov-main.py` to Syzkaller
prefix/suffix (e.g., `'syzkaller_18mins_2023_0707_0410'`).  
**Make sure the `input_cov.pkl` file is renamed corresponding to `default_plot_name`:**
For example, pickle file `input_cov_syzkaller_18mins_2023_0707_0410.pkl`

**Before running `iocov-main.py`, copy the input_cov.pkl to unfilter_input_cov.pkl**.
```bash
cp input_cov_syzkaller_18mins_2023_0707_0410.pkl unfilter_input_cov_syzkaller_18mins_2023_0707_0410.pkl
```

**This can actually be fixed to handle unfiltered input coverage.**

After that, run the following command to generate `*input_coords.pkl` 
(e.g., `syzkaller_18mins_2023_0707_0410_input_coords.pkl`) for plotting and 
rough example figures in the `./src/Assets/Input-Figures` folder.

```bash
python3 iocov-main.py default_plot_name --no-parse --plot -i
```

## MCFS

**Use hyphen ("-") as file names not underscore ("_").**

Parsing MCFS syscalls is documented at [README](../MCFS/README.md).

To plot MCFS input coverage, change `default_plot_name` in `iocov-main.py` to MCFS 
prefix/suffix (e.g., `'mcfs_10m_20230311_005751_2523268'`) and run the following 
command.  
**Make sure the `input-cov.pkl` file is renamed corresponding to `default_plot_name`:**
For example, pickle file `input-cov-mcfs-10m-20230311-005751-2523268.pkl`

**Before running `iocov-main.py`, copy the input-cov.pkl to unfilter-input-cov.pkl**.
```bash
cp input-cov-mcfs-10m-20230311-005751-2523268.pkl unfilter-input-cov-mcfs-10m-20230311-005751-2523268.pkl
```

**This can actually be fixed to handle unfiltered input coverage.**

We can do following way without editting `default_plot_name` manually.  

```bash
python3 iocov-main.py default_plot_name --no-parse --plot -i
```

For example (Note we have to keep the `input-cov-` prefix):

```bash
python3 iocov-main.py input-cov-mcfs-10m-20230311-005751-2523268 --no-parse --plot -i
```

or 

```bash
python3 iocov-main.py input-cov-syzkaller-debug-40mins-2023-0830 --no-parse --plot -i
```

The copy input coords pickle file:

```bash
cp syzkaller-debug-40mins-2023-0830_input_coords.pkl ../FAST2024/input-pickles/
```

## LTTng TRACKING

LTTng gives us the option to track certain processes using their PID. Using this feature, we can efficiently trace syscalls executed by certain process resulting in less noisy LTTng traces. This will result in much cleaner IOCov code and eventually help in calculating input/output coverage for other file systems easily. Documentation is provided here : https://lttng.org/man/1/lttng-track/v2.13/
We 
- Tracking PID does not track child processes. Since xfstests spawns various child worker processes, tracking using PID would lead to not tracking all syscalls
- Through some experiments, we found out that child processes have the same GID as parent proces. Thus, we use GID instead of PID to track xfstests syscalls. We are interested in file system syscalls only, so we can also use the syscall tracking feature provided by LTTng to trace only file system syscalls reducing the noise even further. 
- LTTng setup and run
  - Install lttng by following : https://lttng.org/docs/v2.13/
  - Create a directory /my-dir/my-kernel-trace to store traces
  - Create a lttng session
  ```bash
  sudo lttng create my-kernel-session --output=/my-dir/my-kernel-trace
  ```
  - Enable a channel. Set number of buffer and buffer size according to machine memory. 
  ```bash
  sudo lttng enable-channel --kernel --num-subbuf=4 --subbuf-size=256M my-channel
  ```
  - Enable event. We focus on file system syscalls so we only track relevant ones.
  ```bash
   sudo lttng enable-event -c my-channel --kernel --syscall open,openat,creat,read,pread64,write,pwrite64,lseek,llseek,truncate,ftruncate,mkdir,mkdirat,chmod,fchmod,fchmodat,close,close_range,chdir,fchdir
   ```
  - Create a new group just for running xfstest
  ```bash
  sudo groupadd lttng
  ```

  - Enable tracking feature. Add the GID for fsgqa group as well. 
  ```bash
  sudo lttng track --kernel --session=my-kernel-session --gid=1004,1001
  ```

  - Write a C program that calls a shell script to run. Before calling the shell script, set the GID of the C program. This way the shell script will have the set GID.
   ```bash
  gid_t gid = 1004;
  int er = setgid(gid);
  ```
  ```bash
  system("./run_fsl_xfstests.sh");
  ```
  - After running the C program, start lttng tracing.
  ```bash
  sudo lttng start
  ```

  - Stop lttng tracing when C program finishes
  ```bash
  sudo lttng stop
  ```

  - To view readable logs, use babeltrace
  ```bash
  babeltrace /my-dir/my-kernel-trace
  ```

